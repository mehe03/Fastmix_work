readRDS(file = "SIM_DATA.RDS")
SVD_tester = readRDS(file = "SIM_DATA.RDS")
SVD_tester[1]
df = SVD_tester[[1]]
df
Des = df[c(3,5:8)]
Des
Des = df[c(1,3,5:8)]
Des
Des$X00 = 1
###calculate the var.epsilon
number <- Des %>%
dplyr::group_by(ID) %>%
dplyr::summarize(num = dplyr::n(), .groups = "drop") %>%
dplyr::mutate(start = dplyr::lag(cumsum(num), default = 0),
end = cumsum(num))
libray(tidyverse)
library(tidyverse)
library(tidyverse)
###calculate the var.epsilon
number <- Des %>%
dplyr::group_by(ID) %>%
dplyr::summarize(num = dplyr::n(), .groups = "drop") %>%
dplyr::mutate(start = dplyr::lag(cumsum(num), default = 0),
end = cumsum(num))
number <- cumsum(number[,2]) #idx for each subject
###calculate the var.epsilon
number <- Des %>%
dplyr::group_by(ID) %>%
dplyr::summarize(num = dplyr::n(), .groups = "drop") %>%
dplyr::mutate(start = dplyr::lag(cumsum(num), default = 0),
end = cumsum(num))
Des
###calculate the var.epsilon
number <- Des %>%
dplyr::group_by(subject) %>%
dplyr::summarize(num = dplyr::n(), .groups = "drop") %>%
dplyr::mutate(start = dplyr::lag(cumsum(num), default = 0),
end = cumsum(num))
number <- cumsum(number[,2]) #idx for each subject
number = c(0,number$num)
number
# Step 2: function for per-subject SVD with truncation
subject_svd <- function(mat, tol = 1e-6, use_relative = TRUE) {
svd_obj <- svd(mat)
d <- svd_obj$d
# truncation rule
if (use_relative) {
keep <- d > (max(d) * tol)
} else {
keep <- d > tol
}
# kept components
U_k <- svd_obj$u[, keep, drop = FALSE]
D_k <- diag(d[keep])
V_k <- svd_obj$v[, keep, drop = FALSE]
# truncated (residual) part
U_r <- svd_obj$u[, !keep, drop = FALSE]
D_r <- diag(d[!keep])
V_r <- svd_obj$v[, !keep, drop = FALSE]
# reconstruction of truncated residual
residual_mat <- U_r %*% D_r %*% t(V_r)
# variance of residuals
var_epsilon <- mean(residual_mat^2)
list(
kept = list(U = U_k, D = D_k, V = V_k),
residuals = residual_mat,
var_epsilon = var_epsilon
)
}
# Step 3: apply per subject
results <- list()
for (i in seq_len(nrow(number))) {
idx <- number$start[i]:number$end[i]
mat_i <- Des[idx, , drop = FALSE]
results[[i]] <- subject_svd(mat_i, tol = 1e-6, use_relative = TRUE)
}
# Step 3: apply per subject
results <- list()
for (i in seq_len(length(number) - 1)) {
idx <- (number[i] + 1):number[i + 1]   # rows for subject i
mat_i <- Des[idx, , drop = FALSE]
# Run SVD regression + residuals
results[[i]] <- subject_svd(mat_i, tol = 1e-6, use_relative = TRUE)
}
mat_i
mat_i = mat_i[-1]
mat_i
mat_i
svd(mat_i)
# Step 2: function for per-subject SVD with truncation
subject_svd <- function(mat, tol = 1e-6, use_relative = TRUE) {
mat = mat[-1]
svd_obj <- svd(mat)
d <- svd_obj$d
# truncation rule
if (use_relative) {
keep <- d > (max(d) * tol)
} else {
keep <- d > tol
}
# kept components
U_k <- svd_obj$u[, keep, drop = FALSE]
D_k <- diag(d[keep])
V_k <- svd_obj$v[, keep, drop = FALSE]
# truncated (residual) part
U_r <- svd_obj$u[, !keep, drop = FALSE]
D_r <- diag(d[!keep])
V_r <- svd_obj$v[, !keep, drop = FALSE]
# reconstruction of truncated residual
residual_mat <- U_r %*% D_r %*% t(V_r)
# variance of residuals
var_epsilon <- mean(residual_mat^2)
list(
kept = list(U = U_k, D = D_k, V = V_k),
residuals = residual_mat,
var_epsilon = var_epsilon
)
}
# Step 3: apply per subject
results <- list()
for (i in seq_len(length(number) - 1)) {
idx <- (number[i] + 1):number[i + 1]   # rows for subject i
mat_i <- Des[idx, , drop = FALSE]
# Run SVD regression + residuals
results[[i]] <- subject_svd(mat_i, tol = 1e-6, use_relative = TRUE)
}
mat = mat_i
mat = mat[-1]
svd_obj <- svd(mat)
d <- svd_obj$d
d
# truncation rule
if (use_relative) {
keep <- d > (max(d) * tol)
} else {
keep <- d > tol
}
use_relative = TRUE
# truncation rule
if (use_relative) {
keep <- d >  tol
} else {
keep <- d > tol
}
tol = 1e-6
# truncation rule
if (use_relative) {
keep <- d >  tol
} else {
keep <- d > tol
}
keep
# kept components
U_k <- svd_obj$u[, keep, drop = FALSE]
D_k <- diag(d[keep])
V_k <- svd_obj$v[, keep, drop = FALSE]
U_k
svd_obj$u
mat = mat_i
mat = mat[-c(1,2)]
svd_obj <- svd(mat)
d <- svd_obj$d
# truncation rule
if (use_relative) {
keep <- d >  tol
} else {
keep <- d > tol
}
U_k
mat = mat_i
mat
mat = mat[-c(1,2)]
mat
svd_obj <- svd(mat)
d <- svd_obj$d
# truncation rule
if (use_relative) {
keep <- d >  tol
} else {
keep <- d > tol
}
keep
# kept components
U_k <- svd_obj$u[, keep, drop = FALSE]
U_k
D_k <- diag(d[keep])
V_k <- svd_obj$v[, keep, drop = FALSE]
# truncated (residual) part
U_r <- svd_obj$u[, !keep, drop = FALSE]
D_r <- diag(d[!keep])
V_r <- svd_obj$v[, !keep, drop = FALSE]
U_r
Des
SVD_tester = readRDS(file = "SIM_DATA.RDS")
df = SVD_tester[[1]]
df
df = df[c(1,3,5:8)]
df$X00 = 1
df
###calculate the var.epsilon
number <- df %>%
dplyr::group_by(subject) %>%
dplyr::summarize(num = dplyr::n(), .groups = "drop") %>%
dplyr::mutate(start = dplyr::lag(cumsum(num), default = 0),
end = cumsum(num))
number <- cumsum(number[,2]) #idx for each subject
number = c(0,number$num)
Des = df[-1]
Des
subject_svd <- function(mat, tol = 1e-6, use_relative = TRUE) {
y <- mat[, 1]                 # first col = response
X <- as.matrix(mat[, -1])     # rest = predictors
svd_obj <- svd(X)
d <- svd_obj$d
# truncation rule
if (use_relative) {
keep <- d > d[1] * tol
} else {
keep <- d > tol
}
U_k <- svd_obj$u[, keep, drop = FALSE]
# fitted values and residuals
y_hat <- U_k %*% (t(U_k) %*% y)
resid <- y - y_hat
# variance of residuals
var_epsilon <- mean(resid^2)
list(
residuals = resid,
var_epsilon = var_epsilon,
kept_dim = sum(keep),
dropped_dim = sum(!keep)
)
}
# Step 3: apply per subject
results <- list()
for (i in seq_len(length(number) - 1)) {
idx <- (number[i] + 1):number[i + 1]   # rows for subject i
mat_i <- Des[idx, , drop = FALSE]
# Run SVD regression + residuals
results[[i]] <- subject_svd(mat_i, tol = 1e-6, use_relative = TRUE)
}
# Example: check residual variance for subject 1
results[[1]]$var_epsilon
for(i in 1:70){
print(results[[1]]$var_epsilon
)
}
print(results[[i]]$var_epsilon
)
for(i in 1:70){
print(results[[i]]$var_epsilon
)
}
design_matrix
